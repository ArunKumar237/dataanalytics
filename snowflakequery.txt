create database OUR_FIRST_DB;




CREATE TABLE OUR_FIRST_DB.PUBLIC."loan_payment" (
"loan_id" STRING,
"loan_status" STRING,
"principals" STRING,
"terms" STRING,
"effective_date" STRING,
"due_date" STRING,
"paid_off_time" STRING,
"past_due_date" STRING,
"age" STRING,
"education" STRING,
"gender" STRING
);


select * from loan_payment;


COPY INTO LOAN_PAYMENT
FROM s3://bucketsnowflakes3/Loan_payments_data.csv 
file_format = (type= csv
field_delimiter = ','
skip_header = 1)




CREATE OR REPLACE DATABASE MANAGE_DB;

CREATE OR REPLACE SCHEMA external_stages;


CREATE OR REPLACE STAGE MANAGE_DB.EXTERNAL_STAGES.aws_stage
url='s3://bucketsnowflakes3'
credentials=(aws_key_id='ABCD_DUMMY_ID',aws_secret_key='1234abcd_key')


DESC STAGE manage_db.external_stages.aws_stage;


ALTER STAGE aws_stage
SET credentials=(aws_key_id='XYZ_DUMMY_ID',aws_secret_key='1234abcd_key')



CREATE OR REPLACE STAGE MANAGE_DB.EXTERNAL_STAGES.aws_stage
url='s3://bucketsnowflakes3';



LIST @aws_stage;




COPY INTO LOAN_PAYMENT
FROM s3://bucketsnowflakes3/Loan_payments_data.csv 
file_format = (type= csv
field_delimiter = ','
skip_header = 1)


CREATE OR REPLACE TABLE OUR_FIRST_DB.PUBLIC.ORDERS(
ORDER_ID VARCHAR(30),
AMOUNT INT,
PROFIT INT,
QUANTITY INT,
CATEGORY VARCHAR(30),
SUBCATEGORY VARCHAR(30));

SELECT * FROM OUR_FIRST_DB.PUBLIC.ORDERS;

COPY INTO OUR_FIRST_DB.PUBLIC.ORDERS
FROM @MANAGE_DB.EXTERNAL_STAGES.aws_stage
file_format = (type = csv 
               field_delimiter=','
               skip_header=1)
files = ('OrderDetails.csv')


COPY INTO OUR_FIRST_DB.PUBLIC.ORDERS
FROM @MANAGE_DB.EXTERNAL_STAGES.aws_stage
file_format = (type = csv 
               field_delimiter=','
               skip_header=1)
PATTERN = '.*Order.*' ;


SELECT * FROM OUR_FIRST_DB.PUBLIC.ORDERS;


list @aws_stage;









CREATE OR REPLACE TABLE OUR_FIRST_DB.PUBLIC.ORDERS_EX(
ORDER_ID VARCHAR(30),
AMOUNT INT
);


SELECT * FROM OUR_FIRST_DB.PUBLIC.ORDERS_EX;




COPY INTO OUR_FIRST_DB.PUBLIC.ORDERS_EX
  FROM (select s.$1, s.$2 from @MANAGE_DB.EXTERNAL_STAGES.aws_stage s)
  FILE_FORMAT= (type = csv field_delimiter=',' skip_header=1)
  files=('OrderDetails.csv');



CREATE OR REPLACE TABLE OUR_FIRST_DB.PUBLIC.ORDERS_EX(
ORDER_ID VARCHAR(30),
AMOUNT INT,
PROFIT INT,
PROFITABLE_FLAG VARCHAR(30)
);

SELECT * FROM OUR_FIRST_DB.PUBLIC.ORDERS_EX;


COPY INTO OUR_FIRST_DB.PUBLIC.ORDERS_EX
  FROM (select 
        s.$1,
        s.$2,
        s.$3,
        CASE WHEN CAST(s.$3 as int) < 0 THEN 'not profitable' ELSE 'profitable' END
        from @MANAGE_DB.EXTERNAL_STAGES.aws_stage s)
  FILE_FORMAT= (type = csv field_delimiter=',' skip_header=1)
  files=('OrderDetails.csv');
  
  
  
  
  
  
  
  CREATE OR REPLACE TABLE OUR_FIRST_DB.PUBLIC.ORDERS_EX(
ORDER_ID VARCHAR(30),
AMOUNT INT,
PROFIT INT,
CATEGORY_SUBSTRING VARCHAR(5)
);

SELECT * FROM OUR_FIRST_DB.PUBLIC.ORDERS_EX;


COPY INTO OUR_FIRST_DB.PUBLIC.ORDERS_EX
  FROM (select 
        s.$1,
        s.$2,
        s.$3,
        substring(s.$5, 1, 5)
        from @MANAGE_DB.EXTERNAL_STAGES.aws_stage s)
  FILE_FORMAT= (type = csv field_delimiter=',' skip_header=1)
  files=('OrderDetails.csv');


SELECT * FROM OUR_FIRST_DB.PUBLIC.ORDERS_EX;


COPY INTO OUR_FIRST_DB.PUBLIC.ORDERS_EX(ORDER_ID,PROFIT)
  FROM (select 
        s.$1,
        s.$3
        from @MANAGE_DB.EXTERNAL_STAGES.aws_stage s)
  FILE_FORMAT= (type = csv field_delimiter=',' skip_header=1)
  files=('OrderDetails.csv');


CREATE OR REPLACE STAGE MANAGE_DB.EXTERNAL_STAGES.aws_stage_errorex
url='s3://bucketsnowflakes4'

LIST @MANAGE_DB.EXTERNAL_STAGES.aws_stage_errorex



CREATE OR REPLACE TABLE OUR_FIRST_DB.PUBLIC.ORDERS_EX(
ORDER_ID VARCHAR(30),
AMOUNT INT,
PROFIT INT,
QUANTITY INT,
CATEGORY VARCHAR(30),
SUBCATEGORY VARCHAR(30));




COPY INTO OUR_FIRST_DB.PUBLIC.ORDERS_EX
  FROM @MANAGE_DB.EXTERNAL_STAGES.aws_stage_errorex
  FILE_FORMAT= (type = csv field_delimiter=',' skip_header=1)
  files=('OrderDetails_error.csv','OrderDetails_error2.csv')
  ON_ERROR = 'CONTINUE';
  

select * from OUR_FIRST_DB.PUBLIC.ORDERS_EX;

SELECT COUNT(*) from OUR_FIRST_DB.PUBLIC.ORDERS_EX;






//------------------------------------------------------------------------------

//FILE FORMATS


CREATE OR REPLACE TABLE OUR_FIRST_DB.PUBLIC.ORDERS_EX(
ORDER_ID VARCHAR(30),
AMOUNT INT,
PROFIT INT,
QUANTITY INT,
CATEGORY VARCHAR(30),
SUBCATEGORY VARCHAR(30));



CREATE OR REPLACE SCHEMA MANAGE_DB.FILE_FORMATS;

CREATE OR REPLACE file format MANAGE_DB.FILE_FORMATS.my_file_format;

DESC file format MANAGE_DB.FILE_FORMATS.my_file_format;


COPY INTO OUR_FIRST_DB.PUBLIC.ORDERS_EX
  FROM @MANAGE_DB.EXTERNAL_STAGES.aws_stage_errorex
  FILE_FORMAT= (FORMAT_NAME=MANAGE_DB.FILE_FORMATS.my_file_format)
  files=('OrderDetails_error.csv','OrderDetails_error2.csv')
  ON_ERROR = 'SKIP_FILE_3';

SELECT * FROM OUR_FIRST_DB.PUBLIC.ORDERS_EX;

truncate table OUR_FIRST_DB.PUBLIC.ORDERS_EX; 


ALTER file format MANAGE_DB.FILE_FORMATS.my_file_format
  SET SKIP_HEADER = 1;


  
CREATE OR REPLACE file format MANAGE_DB.FILE_FORMATS.my_file_format
TYPE = CSV,
TIME_FORMAT=AUTO;

DESC file format MANAGE_DB.FILE_FORMATS.my_file_format;

ALTER file format MANAGE_DB.FILE_FORMATS.my_file_format
  SET TYPE = CSV;
  
  
  ----------------------------------------------------------------------------------------------------------------------------------
